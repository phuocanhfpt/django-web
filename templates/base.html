{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ site_settings.meta_title|default:site_settings.site_name }}{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}{{ site_settings.meta_description|default:site_settings.description }}{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}{{ site_settings.meta_keywords }}{% endblock %}">
    <link rel="canonical" href="{% block canonical_url %}{{ request.build_absolute_uri }}{% endblock %}">
    {% if site_settings and site_settings.favicon %}
    <link rel="icon" type="image/png" href="{{ site_settings.favicon.url }}">
    {% endif %}
    {% if site_settings and site_settings.google_search_console_code %}
    {{ site_settings.google_search_console_code|safe }}
    {% endif %}
    {% if site_settings and site_settings.google_analytics_code %}
    {{ site_settings.google_analytics_code|safe }}
    {% endif %}

    {# --- Open Graph / Facebook --- #}
    {% block meta_og %}
    <meta property="og:type" content="website">
    <meta property="og:title" content="{{ site_settings.meta_title|default:site_settings.site_name }}">
    <meta property="og:description" content="{{ site_settings.meta_description|default:site_settings.description }}">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:image" content="{% if site_settings.og_image %}{{ site_settings.og_image.url }}{% endif %}">
    <meta property="og:site_name" content="{{ site_settings.site_name }}">
    {% endblock %}

    {# --- Twitter Card --- #}
    {% block meta_twitter %}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ site_settings.meta_title|default:site_settings.site_name }}">
    <meta name="twitter:description" content="{{ site_settings.meta_description|default:site_settings.description }}">
    <meta name="twitter:image" content="{% if site_settings.og_image %}{{ site_settings.og_image.url }}{% endif %}">
    {% endblock %}

    {# --- Schema.org Organization --- #}
    {% block meta_schema %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "{{ site_settings.site_name }}",
      "url": "{{ request.scheme }}://{{ request.get_host }}",
      "logo": "{% if site_settings.logo %}{{ site_settings.logo.url }}{% endif %}",
      "description": "{{ site_settings.meta_description|default:site_settings.description }}",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "{{ site_settings.address }}",
        "addressLocality": "{{ site_settings.city }}",
        "addressRegion": "{{ site_settings.state }}",
        "postalCode": "{{ site_settings.postal_code }}",
        "addressCountry": "VN"
      },
      "contactPoint": {
        "@type": "ContactPoint",
        "telephone": "{{ site_settings.phone }}",
        "contactType": "customer service",
        "email": "{{ site_settings.email }}"
      },
      "sameAs": [
        "{{ site_settings.facebook_url }}",
        "{{ site_settings.youtube_url }}",
        "{{ site_settings.instagram_url }}"
      ]
    }
    </script>
    {% endblock %}

    {# --- Schema.org BreadcrumbList --- #}
    {% block meta_breadcrumb %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "name": "Trang chủ",
        "item": "{{ request.scheme }}://{{ request.get_host }}/"
      }]
    }
    </script>
    {% endblock %}

    {# --- Schema.org WebSite --- #}
    {% block meta_website %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "{{ site_settings.site_name }}",
      "url": "{{ request.scheme }}://{{ request.get_host }}",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "{{ request.scheme }}://{{ request.get_host }}/search?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    {% endblock %}

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <style>
        :root {
            --main-green: #2196f3;
            --main-green-dark: #1769aa;
        }
        .navbar {
            background: var(--main-green) !important;
        }
        .navbar .navbar-brand, .navbar .nav-link, .navbar .navbar-brand span {
            color: #fff !important;
        }
        .navbar .nav-link.active, .navbar .nav-link:hover {
            color: #e3f2fd !important;
        }
        .navbar .navbar-brand span {
            font-weight: bold;
            font-size: 1.3rem;
            letter-spacing: 1px;
        }
        .navbar .form-control {
            border-radius: 20px;
        }
        .navbar .btn-outline-success {
            border-radius: 20px;
            border-color: #fff;
            color: #fff;
            background: var(--main-green-dark);
        }
        .navbar .btn-outline-success:hover {
            background: #fff;
            color: var(--main-green-dark);
        }
        .navbar .bi {
            vertical-align: -0.125em;
        }
        .navbar .badge {
            font-size: 0.75em;
        }
        .navbar-toggler {
            border: none;
            background: transparent !important;
            box-shadow: none !important;
            padding: 0.25rem 0.5rem;
        }
        .navbar-toggler .bi {
            font-size: 2rem;
            color: #fff;
        }
        .mobile-icons {
            display: flex !important;
            align-items: center;
            gap: 0.5rem;
        }
        /* --- FIX NAVBAR ALIGN --- */
        .navbar .container.d-flex {
            min-height: 64px;
            height: 64px;
        }
        .navbar .navbar-nav,
        .navbar .desktop-icons {
            height: 48px;
            align-items: center !important;
            display: flex !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
        .navbar .navbar-nav > li,
        .navbar .desktop-icons > li {
            height: 48px;
            display: flex;
            align-items: center;
        }
        .search-form-navbar {
            height: 48px;
            display: flex !important;
            align-items: center !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
        .search-form-navbar input.form-control {
            height: 40px !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }
        /* --- END FIX NAVBAR ALIGN --- */
        @media (max-width: 991.98px) {
            .navbar .navbar-brand span {
                font-size: 1rem;
            }
            .navbar .mobile-icons {
                display: flex !important;
            }
            .navbar .desktop-icons {
                display: none !important;
            }
            .search-form-navbar {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 0 1rem 0 !important;
            }
            .search-form-navbar input.form-control {
                width: 100% !important;
            }
        }
        @media (min-width: 992px) {
            /* Ẩn nút hamburger và offcanvas mobile menu trên desktop */
            .d-lg-none,
            #mobileMenu {
                display: none !important;
            }
            .navbar .mobile-icons {
                display: none !important;
            }
            .navbar .desktop-icons {
                display: flex !important;
            }
        }
        body {
            background: #f4f8fb;
        }
        .dropdown-menu {
            max-height: 350px;
            overflow-y: auto;
        }
        .dropdown-menu .dropdown-item {
            transition: background 0.2s, color 0.2s;
            border-radius: 8px;
            margin: 2px 4px;
            padding: 8px 14px;
        }
        .dropdown-menu .dropdown-item:hover, .dropdown-menu .dropdown-item:focus {
            background: #e3f2fd;
            color: #1769aa;
        }
        .dropdown-menu img {
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        /* Footer styles */
        footer {
            background: var(--main-green) !important;
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            color: #fff;
            font-size: 1.04rem;
            letter-spacing: 0.01em;
        }
        footer h5 {
            font-size: 1.08rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 1rem;
            letter-spacing: 0.01em;
        }
        footer .fw-bold, footer .footer-title {
            color: #fff;
            font-weight: 700;
        }
        footer p, footer li, footer .text-white-50, footer .small {
            color: rgba(255,255,255,0.85) !important;
            font-size: 1.01rem;
            font-weight: 400;
            margin-bottom: 0.4rem;
            letter-spacing: 0.01em;
        }
        footer ul li {
            margin-bottom: 0.4rem;
        }
        footer a, footer .text-white-50 {
            color: rgba(255,255,255,0.88) !important;
            font-size: 1.04rem;
            font-weight: 600;
            text-decoration: none !important;
            transition: color 0.22s, text-decoration 0.22s, box-shadow 0.22s;
            border-radius: 4px;
            padding: 1px 2px;
        }
        footer a:hover, footer .text-white-50:hover {
            color: #fff !important;
            text-decoration: underline !important;
            background: rgba(255,255,255,0.08);
            box-shadow: 0 2px 8px rgba(33,150,243,0.08);
        }
        footer .social-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            color: #fff !important;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, color 0.2s, transform 0.2s;
        }
        footer .social-icon:hover {
            background: #fff;
            color: var(--main-green) !important;
            transform: translateY(-2px) scale(1.08);
        }
        footer .bi, footer .fa {
            vertical-align: middle;
        }
        footer hr {
            border-color: rgba(255,255,255,0.18);
        }
        footer .text-center.small {
            color: rgba(255,255,255,0.7) !important;
            font-size: 0.98rem;
            margin-top: 0.7rem;
        }
        #floating-buttons {
            position: fixed;
            z-index: 9999;
            right: 24px;
            bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .floating-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: var(--main-green, #2196f3);
            color: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            font-size: 1.5rem;
            transition: background 0.2s, transform 0.2s;
            text-decoration: none !important;
            border: none;
            outline: none;
        }
        .floating-btn:hover {
            background: var(--main-green-dark, #1769aa);
            transform: translateY(-2px) scale(1.08);
            color: #fff;
        }
        .floating-btn img {
            width: 28px;
            height: 28px;
            display: block;
        }
        .call-btn {
            background: #25d366;
        }
        .call-btn:hover {
            background: #128c7e;
        }
        .zalo-btn {
            background: #008fe5;
        }
        .zalo-btn:hover {
            background: #006bb3;
        }
        h1, h2, h3, h4, h5 {
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            font-weight: 700;
            color: #1769aa;
            margin-top: 0.5em;
            margin-bottom: 0.6em;
            line-height: 1.22;
            letter-spacing: 0.01em;
        }
        h1 { font-size: 1.45rem; }
        h2 { font-size: 1.18rem; }
        h3 { font-size: 1.05rem; }
        h4 { font-size: 0.98rem; }
        h5 { font-size: 0.93rem; }
        @media (max-width: 768px) {
            h1 { font-size: 1.18rem; }
            h2 { font-size: 1.05rem; }
            h3 { font-size: 0.97rem; }
            h4 { font-size: 0.93rem; }
            h5 { font-size: 0.91rem; }
        }
        /* Section & card spacing */
        section, .section, .container, .container-fluid {
            margin-bottom: 2.2rem;
            margin-top: 0;
        }
        .card, .shadow-sm {
            margin-bottom: 1.5rem;
        }
        .section-title {
            margin-bottom: 1.1rem;
            margin-top: 0.4rem;
        }
        .mb-0 { margin-bottom: 0 !important; }
        .mb-1 { margin-bottom: 0.25rem !important; }
        .mb-2 { margin-bottom: 0.5rem !important; }
        .mb-3 { margin-bottom: 1rem !important; }
        .mb-4 { margin-bottom: 1.5rem !important; }
        .mb-5 { margin-bottom: 2rem !important; }
        .mt-0 { margin-top: 0 !important; }
        .mt-1 { margin-top: 0.25rem !important; }
        .mt-2 { margin-top: 0.5rem !important; }
        .mt-3 { margin-top: 1rem !important; }
        .mt-4 { margin-top: 1.5rem !important; }
        .mt-5 { margin-top: 2rem !important; }
        /* Table & form spacing */
        table { margin-bottom: 1.2rem; }
        form { margin-bottom: 1.2rem; }
        /* Remove double spacing for last-child */
        section:last-child, .container:last-child, .card:last-child, .shadow-sm:last-child {
            margin-bottom: 0 !important;
        }
        /* --- PRODUCT CARD BUTTONS UNIFY (FINAL, FIX FLEX) --- */
        .product-card .product-actions,
        .related-product-card .product-actions {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 0.7rem;
            align-items: center !important;
            justify-content: center;
            width: 100%;
            margin-top: 0.5rem;
        }
        .product-card .product-actions .btn,
        .related-product-card .product-actions .btn {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            height: 38px !important;
            line-height: 38px !important;
            font-size: 0.97rem;
            font-weight: 500;
            border-radius: 8px !important;
            gap: 0.5em;
            box-shadow: none;
            min-width: 0;
            margin: 0;
            padding: 0 1.2em;
            width: auto !important;
            max-width: 100%;
            white-space: nowrap !important;
        }
        .product-card .product-actions .btn-success,
        .related-product-card .product-actions .btn-success {
            min-width: 0 !important;
            max-width: 100%;
            flex: unset;
            align-self: center;
        }
        .product-card .product-actions .btn i,
        .related-product-card .product-actions .btn i {
            font-size: 1.15em;
            margin-right: 0.4em;
            margin-bottom: 0 !important;
            vertical-align: middle;
        }
        .product-card .product-actions .btn-success i,
        .related-product-card .product-actions .btn-success i {
            margin-right: 0.4em;
        }
        .product-card .product-image-wrapper,
        .related-product-card .product-image-wrapper {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .product-card .product-image-wrapper:hover,
        .related-product-card .product-image-wrapper:hover {
            opacity: 0.9;
        }
        .product-card .product-title,
        .related-product-card .product-title {
            cursor: pointer;
            transition: color 0.2s;
        }
        .product-card .product-title:hover,
        .related-product-card .product-title:hover {
            color: var(--main-green);
        }
        @media (max-width: 575.98px) {
            .product-card .product-actions,
            .related-product-card .product-actions {
                justify-content: flex-start !important;
                gap: 0.5em !important;
            }
            .product-card .product-actions .btn,
            .related-product-card .product-actions .btn,
            .btn-add-cart {
                font-size: 0.97rem !important;
                padding: 0.45em 0.7em !important;
                height: 34px !important;
                min-width: unset !important;
                width: auto !important;
                white-space: nowrap !important;
                border-radius: 16px !important;
                display: inline-flex !important;
                align-items: center !important;
                gap: 0.4em !important;
                box-shadow: none !important;
                background: #219653 !important;
                color: #fff !important;
                border: none !important;
                font-weight: 600 !important;
            }
            .btn-add-cart i {
                margin-right: 0.25em !important;
                font-size: 1em !important;
                color: #fff !important;
            }
        }
        /* --- END PRODUCT CARD BUTTONS UNIFY (FINAL, FIX FLEX) --- */
        .btn-add-cart {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: auto !important;
            min-width: 0 !important;
            max-width: 100%;
            background: #219653;
            color: #fff !important;
            border: none;
            border-radius: 999px;
            font-size: 1.08rem;
            font-weight: 600;
            padding: 0.7em 1.5em;
            height: 44px;
            box-shadow: 0 2px 8px rgba(33,150,83,0.08);
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            gap: 0.7em;
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .btn-add-cart i {
            color: #fff !important;
            font-size: 1.15em;
            margin-right: 0.5em;
        }
        .btn-add-cart:hover, .btn-add-cart:focus {
            background: #17693a;
            color: #fff !important;
            box-shadow: 0 4px 16px rgba(33,150,83,0.16);
        }
        .offcanvas .list-group-item {
            border: none;
            font-size: 1.08rem;
            background: transparent;
            padding: 12px 18px;
            color: #222;
            transition: background 0.2s, color 0.2s;
        }
        .offcanvas .list-group-item a,
        .offcanvas .list-group-item button {
            color: #222;
            background: none;
            border: none;
            font-size: 1.08rem;
            padding: 0;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 400;
            box-shadow: none;
            text-decoration: none;
            transition: color 0.2s;
        }
        .offcanvas .list-group-item a:hover,
        .offcanvas .list-group-item button:hover {
            color: #2196f3;
            background: none;
        }
        .offcanvas .list-group-item.active > a,
        .offcanvas .list-group-item.active > button {
            color: #2196f3;
            font-weight: 500;
        }
        .offcanvas .list-group-item .bi {
            font-size: 1.15em;
        }
        #productCategoriesList {
            padding-left: 0;
        }
        #productCategoriesList .list-group-item {
            padding-left: 32px;
            font-size: 1.04rem;
            background: transparent;
        }
        #productCategoriesList .list-group-item a {
            color: #444;
            font-size: 1.04rem;
            padding: 0;
        }
        #productCategoriesList .list-group-item a:hover {
            color: #2196f3;
        }
        .d-lg-none .nav-link, .d-lg-none .navbar-toggler {
            padding: 0 6px !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .d-lg-none .nav-link i, .d-lg-none .navbar-toggler i {
            font-size: 1.7rem;
            line-height: 1;
        }
        .d-lg-none .navbar-toggler {
            border: none;
            background: none;
            box-shadow: none;
        }
        #cartDropdownBadgeMobile {
            min-width: 16px;
            height: 16px;
            font-size: 0.75em;
            padding: 0 4px;
            top: 2px !important;
            right: 0px !important;
            line-height: 16px;
        }
        .d-lg-none .nav-item.dropdown, .d-lg-none .nav-link, .d-lg-none .navbar-toggler {
            height: 40px;
            width: 40px;
            margin: 0 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .d-lg-none .nav-link {
            background: none !important;
        }
        /* --- NÚT HIỂN THỊ THÊM (LOAD MORE BUTTON) ĐỒNG BỘ --- */
        .load-more-btn, #load-more-search {
            background: #0d6efd;
            color: #fff;
            border: none;
            padding: 7px 0;
            border-radius: 22px;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(13,110,253,0.08);
            transition: all 0.2s;
            letter-spacing: 0.5px;
            width: 100%;
            max-width: 180px;
            margin: 24px auto 0 auto;
            display: block;
        }
        .load-more-btn:hover, .load-more-btn:focus, #load-more-search:hover, #load-more-search:focus {
            background: #1769aa;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13,110,253,0.12);
        }
        .load-more-btn:disabled, #load-more-search:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        /* --- END NÚT HIỂN THỊ THÊM --- */

        /* --- PRODUCT CARD STYLES --- */
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: none !important;
            background: #fff;
            overflow: hidden;
        }
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
        }
        .product-card .product-image-wrapper {
            position: relative;
            padding-top: 100%;
            overflow: hidden;
            background: #f8f9fa;
        }
        .product-card .product-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        .product-card:hover .product-image {
            transform: scale(1.05);
        }
        .product-card .product-title {
            font-size: 1rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 2.5em;
            line-height: 1.25;
        }
        .product-card .card-body {
            padding: 1rem;
        }
        .product-card .product-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .product-card .product-actions .btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 8px;
        }
        .product-card .product-actions .btn i {
            font-size: 1rem;
        }
        .product-card .badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
            border-radius: 6px;
        }
        @media (max-width: 575.98px) {
            .product-card .product-title {
                font-size: 0.95rem;
                height: 2.4em;
            }
            .product-card .product-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            .product-card .product-actions .btn {
                width: 100%;
                font-size: 0.9rem;
                padding: 0.4rem;
            }
        }
        /* --- END PRODUCT CARD STYLES --- */
    </style>
    {% block extra_head %}{% endblock %}
    {% block extra_css %}{% endblock %}
</head>
<body>
{% include 'chat/widget.html' %}
<nav class="navbar navbar-expand-lg shadow-sm">
  <div class="container d-flex align-items-center" style="min-height:64px;">
    <a class="navbar-brand d-flex align-items-center" href="/">
      <img src="{% static 'images/Logo.png' %}" alt="Logo" width="48" height="48" class="me-2" style="background:#fff;border-radius:50%;padding:2px;">
      <span>CAMERA HCM</span>
    </a>
    <!-- ICONS MOBILE + HAMBURGER: show on mobile, hide on desktop -->
    <div class="d-lg-none d-flex align-items-center ms-auto" style="gap:0.5rem;">
      {% if user.is_authenticated and user.is_staff %}
        <!-- Icon tư vấn admin mobile -->
        <button id="admin-consult-bell-mobile" class="btn btn-link p-0 position-relative" style="color: #222;" title="Thông báo tư vấn">
          <i class="bi bi-clipboard-check fs-4"></i>
          <span id="admin-consult-badge-mobile" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.8em; z-index:1; display:none;">0</span>
        </button>
        <!-- Icon chat admin mobile -->
        <button id="admin-chat-bell-mobile" class="btn btn-link p-0 position-relative" style="color: #222;" title="Thông báo chat" data-is-admin="true">
          <i class="bi bi-bell fs-4"></i>
          <span id="admin-chat-badge-mobile" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.8em; z-index:1; display:none;">0</span>
        </button>
      {% else %}
        <!-- Icon giỏ hàng mobile (không phải admin) -->
      <div class="nav-item dropdown">
        <a href="#" class="nav-link position-relative dropdown-toggle" id="cartDropdownMobile" role="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-cart3"></i>
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartDropdownBadgeMobile" style="display:none;">0</span>
        </a>
        <div class="dropdown-menu dropdown-menu-end p-0" aria-labelledby="cartDropdownMobile" style="width: 320px;">
          <div id="cartDropdownContentMobile"></div>
        </div>
      </div>
      {% endif %}
      <!-- Icon đăng nhập mobile -->
      {% if user.is_authenticated %}
        <div class="nav-item dropdown">
          <a class="nav-link p-2 dropdown-toggle d-flex align-items-center gap-2" href="#" id="userDropdownMobile" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-person-circle fs-4"></i>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdownMobile">
            <li class="dropdown-header text-center">
              <div class="fw-bold">Chào, {{ user.userprofile.full_name|default:user.username }}</div>
              <div class="small text-muted">{{ user.email }}</div>
              {% if user.userprofile.phone %}<div class="small">{{ user.userprofile.phone }}</div>{% endif %}
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a href="{% url 'accounts:profile' %}" class="dropdown-item">
                <i class="fa fa-user me-2 text-primary"></i>Trang cá nhân
              </a>
            </li>
            {% if user.is_staff %}
            <li>
              <a href="{% url 'dashboard_admin' %}" class="dropdown-item">
                <i class="fa fa-tachometer-alt me-2 text-primary"></i>Admin Dashboard
              </a>
            </li>
            {% endif %}
            <li>
              <form method="post" action="{% url 'account_logout' %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="dropdown-item text-danger" style="background:none;border:none;padding:0;width:100%;text-align:left;">
                  <i class="fa fa-sign-out-alt me-2"></i>Thoát
                </button>
              </form>
            </li>
          </ul>
        </div>
      {% else %}
        <a class="nav-link p-2" href="{% url 'account_login' %}"><i class="bi bi-person fs-4"></i></a>
      {% endif %}
      <!-- Nút mở menu -->
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu" aria-controls="mobileMenu" aria-label="Toggle navigation">
        <i class="bi bi-list" id="navbarTogglerIcon"></i>
      </button>
    </div>
    <!-- Offcanvas Mobile Menu -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileMenu" aria-labelledby="mobileMenuLabel">
      <div class="offcanvas-header">
        <form class="w-100 d-flex align-items-center position-relative" action="{% url 'products:search_results' %}" method="get">
          <input class="form-control pe-5" type="search" name="q" placeholder="Bạn cần tìm..." aria-label="Search" style="border-radius: 30px;">
          <button class="btn position-absolute end-0 top-50 translate-middle-y me-2 p-0 border-0 bg-transparent" type="submit" style="z-index:2;">
            <i class="bi bi-search fs-5 text-primary"></i>
          </button>
        </form>
        <button type="button" class="btn-close text-reset ms-2" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body p-0">
        <ul class="list-group list-group-flush">
          <li class="list-group-item">
            <a href="/" class="d-flex align-items-center"><i class="bi bi-house me-2"></i> Trang chủ</a>
          </li>
          <li class="list-group-item">
            <button id="toggleProductCategories" class="d-flex align-items-center justify-content-between w-100 btn btn-link text-start" type="button" style="box-shadow:none;text-decoration:none;">
              <span><i class="bi bi-grid me-2"></i> Danh mục sản phẩm</span>
              <i class="bi bi-chevron-down" id="chevronProductCategories"></i>
            </button>
            <div id="productCategoriesList" class="d-none mt-2">
              <ul class="list-group list-group-flush ms-3">
                {% for cat in product_categories %}
                <li class="list-group-item p-1 border-0">
                  <a href="{{ cat.get_absolute_url }}" class="d-flex align-items-center">
                    {% if cat.image %}
                      <img src="{{ cat.image.url }}" alt="{{ cat.name }}" style="width:22px;height:22px;object-fit:cover;border-radius:4px;margin-right:8px;">
                    {% else %}
                      <i class="fa fa-folder text-primary me-2"></i>
                    {% endif %}
                    {{ cat.name }}
                  </a>
                </li>
                {% endfor %}
              </ul>
            </div>
          </li>
          <li class="list-group-item">
            <a href="{% url 'posts:post_list' %}" class="d-flex align-items-center"><i class="bi bi-newspaper me-2"></i> Tin tức</a>
          </li>
          <li class="list-group-item">
            <a href="/contact/" class="d-flex align-items-center"><i class="bi bi-envelope me-2"></i> Liên hệ</a>
          </li>
        </ul>
      </div>
    </div>
    <div class="collapse navbar-collapse" id="mainNavbar">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0 align-items-center" style="display:flex;">
        <!-- Dropdown Sản phẩm -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Sản phẩm
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            {% for cat in product_categories %}
            <li>
              <a class="dropdown-item d-flex align-items-center justify-content-between py-2" href="{{ cat.get_absolute_url }}">
                <span class="d-flex align-items-center">
                  {% if cat.image %}
                    <img src="{{ cat.image.url }}" alt="{{ cat.name }}" style="width:28px;height:28px;object-fit:cover;border-radius:6px;margin-right:10px;">
                  {% else %}
                    <i class="fa fa-folder fa-lg text-primary me-2"></i>
                  {% endif %}
                  <span>{{ cat.name }}</span>
                </span>
                <span class="badge bg-primary rounded-pill ms-2">{{ cat.product_count }}</span>
              </a>
            </li>
            {% endfor %}
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link" href="{% url 'posts:post_list' %}">Tin tức</a></li>
        <li class="nav-item"><a class="nav-link" href="/contact/">Liên hệ</a></li>
      </ul>
      <form class="d-flex align-items-center me-3 position-relative search-form-navbar" action="{% url 'products:search_results' %}" method="get" style="max-width:300px;width:100%;">
        <input class="form-control ps-3 pe-5" type="search" name="q" placeholder="Tìm kiếm..." aria-label="Search" style="border-radius: 30px; height:40px;">
        <button class="btn position-absolute end-0 top-50 translate-middle-y me-2 p-0 border-0 bg-transparent" type="submit" style="z-index:2;">
          <i class="bi bi-search fs-5 text-primary"></i>
        </button>
      </form>
      <!-- ICONS DESKTOP: show on desktop, hide on mobile -->
      <ul class="navbar-nav mb-2 mb-lg-0 align-items-center desktop-icons" style="display:flex;">
        <li class="nav-item me-3 d-flex align-items-center">
          <div class="nav-item dropdown d-flex align-items-center">
            <a href="#" class="nav-link position-relative dropdown-toggle d-flex align-items-center" id="cartDropdownDesktop" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="padding:0 10px;">
              <i class="fas fa-shopping-cart" style="font-size:1.25rem;"></i>
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartDropdownBadgeDesktop" style="display:none;min-width:22px;font-size:0.95em;transform:translate(-50%,-40%);">0</span>
            </a>
            <div class="dropdown-menu dropdown-menu-end p-0" aria-labelledby="cartDropdownDesktop" style="width: 320px;">
              <div id="cartDropdownContentDesktop"></div>
            </div>
          </div>
        </li>
        <li class="nav-item d-flex align-items-center">
          {% if user.is_authenticated %}
            <div class="nav-item dropdown d-flex align-items-center">
              <a class="nav-link p-2 dropdown-toggle d-flex align-items-center gap-2" href="#" id="userDropdownDesktop" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle fs-4"></i>
                <span class="fw-bold d-none d-md-inline">Chào, {{ user.userprofile.full_name|default:user.username }}</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdownDesktop">
                <li class="dropdown-header text-center">
                  <div class="fw-bold">Chào, {{ user.userprofile.full_name|default:user.username }}</div>
                  <div class="small text-muted">{{ user.email }}</div>
                  {% if user.userprofile.phone %}<div class="small">{{ user.userprofile.phone }}</div>{% endif %}
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a href="{% url 'accounts:profile' %}" class="dropdown-item">
                    <i class="fa fa-user me-2 text-primary"></i>Trang cá nhân
                  </a>
                </li>
                {% if user.is_staff %}
                <li>
                  <a href="{% url 'dashboard_admin' %}" class="dropdown-item">
                    <i class="fa fa-tachometer-alt me-2 text-primary"></i>Admin Dashboard
                  </a>
                </li>
                {% endif %}
                <li>
                  <form method="post" action="{% url 'account_logout' %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="dropdown-item text-danger" style="background:none;border:none;padding:0;width:100%;text-align:left;">
                      <i class="fa fa-sign-out-alt me-2"></i>Thoát
                    </button>
                  </form>
                </li>
              </ul>
            </div>
          {% else %}
            <a class="nav-link d-flex align-items-center" href="{% url 'account_login' %}"><i class="bi bi-person fs-4"></i></a>
          {% endif %}
        </li>
        {% if user.is_authenticated and user.is_staff %}
        <li class="nav-item d-flex align-items-center">
          <div class="position-relative" style="display:inline-block;">
            <button id="admin-consult-bell" class="btn btn-link p-0" style="color: #222;" title="Thông báo tư vấn">
              <i class="bi bi-clipboard-check fs-4"></i>
              <span id="admin-consult-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.8em; z-index:1; display:none;">0</span>
            </button>
          </div>
        </li>
        <li class="nav-item d-flex align-items-center">
          <div class="position-relative" style="display:inline-block;">
            <button id="admin-chat-bell" class="btn btn-link p-0" style="color: #222;">
              <i class="bi bi-bell fs-4"></i>
              <span id="admin-chat-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.8em; z-index:1; display:none;">0</span>
            </button>
          </div>
        </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  {% block breadcrumb %}{% endblock %}
  {% block content %}{% endblock %}
</div>

<footer class="mt-5 bg-primary text-white pt-4 pb-2">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-md-6 mb-3">
        <h5 class="fw-bold mb-3">{{ footer.company_name }}</h5>
        <ul class="list-unstyled">
          <li class="mb-2"><i class="bi bi-geo-alt me-2"></i>{{ footer.address }}</li>
          <li class="mb-2"><i class="bi bi-telephone me-2"></i>Hotline: {{ footer.hotline }}</li>
          <li class="mb-2"><i class="bi bi-telephone me-2"></i>Hỗ trợ kỹ thuật: {{ footer.technical_support }}</li>
          <li class="mb-2"><i class="bi bi-telephone me-2"></i>Kinh doanh: {{ footer.business_phone }}</li>
          <li class="mb-2"><i class="bi bi-envelope me-2"></i>{{ footer.email }}</li>
        </ul>
      </div>
      {% for group in menu_groups %}
      <div class="col-lg-3 col-md-6 mb-3">
        <h5 class="fw-bold mb-3">{{ group.title }}</h5>
        <ul class="list-unstyled">
          {% for menu in group.menus.all|slice:":6" %}
            {% if menu.is_active %}
              <li class="mb-2">
                <a href="{{ menu.url }}" class="text-white-50">
                  <i class="fa fa-angle-right me-2"></i>{{ menu.title }}
                </a>
              </li>
            {% endif %}
          {% endfor %}
        </ul>
      </div>
      {% endfor %}
      <div class="col-lg-3 col-md-6 mb-3">
        <h5 class="fw-bold mb-3">Kết nối với chúng tôi</h5>
        <div class="mb-3">
          {% if footer.facebook_url %}
          <a href="{{ footer.facebook_url }}" class="text-white me-3 fs-4 social-icon"><i class="bi bi-facebook"></i></a>
          {% endif %}
          {% if footer.youtube_url %}
          <a href="{{ footer.youtube_url }}" class="text-white me-3 fs-4 social-icon"><i class="bi bi-youtube"></i></a>
          {% endif %}
          {% if footer.instagram_url %}
          <a href="{{ footer.instagram_url }}" class="text-white me-3 fs-4 social-icon"><i class="bi bi-instagram"></i></a>
          {% endif %}
          {% if footer.tiktok_url %}
          <a href="{{ footer.tiktok_url }}" class="text-white me-3 fs-4 social-icon"><i class="bi bi-tiktok"></i></a>
          {% endif %}
          {% if footer.zalo_url %}
          <a href="{{ footer.zalo_url }}" class="text-white me-3 fs-4 social-icon" title="Zalo" target="_blank" rel="noopener" style="vertical-align:middle;display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;">
            <svg width="24" height="24" viewBox="0 0 32 32" fill="none" style="display:block;" xmlns="http://www.w3.org/2000/svg">
              <circle cx="16" cy="16" r="16" fill="#008fe5"/>
              <text x="16" y="20" text-anchor="middle" font-size="16" font-family="Arial, Helvetica, sans-serif" fill="#fff" font-weight="bold" dominant-baseline="middle">Z</text>
            </svg>
          </a>
          {% endif %} 
        </div>
        <p class="text-white-50 small">Giờ làm việc: {{ footer.working_hours }}</p>
      </div>
    </div>
    <hr class="border-light">
    <div class="text-center small">
      {{ footer.get_copyright_text }}
      <span class="ms-3"><a href="/sitemap/" rel="sitemap" class="text-white-50"><i class="bi bi-diagram-3 me-1"></i>Site Map</a></span>
    </div>
  </div>
</footer>

<!-- Floating Action Buttons -->
<div id="floating-buttons">
  <!-- Back to Top -->
  <a href="#" id="backToTop" class="floating-btn" title="Lên đầu trang">
    <i class="fa fa-arrow-up"></i>
  </a>
  <!-- Call -->
  <a href="tel:0822223000" class="floating-btn call-btn" title="Gọi ngay: 08.2222.300">
    <i class="fa fa-phone"></i>
  </a>
  <!-- Zalo -->
  {% if site_settings.zalo_url %}
  <a href="{{ site_settings.zalo_url }}" class="floating-btn zalo-btn" title="Chat Zalo" target="_blank" rel="noopener">
    <span style="display:inline-block;width:28px;height:28px;">
      <svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="16" cy="16" r="16" fill="#008fe5"/>
        <text x="16" y="21" text-anchor="middle" font-size="14" font-family="Arial, Helvetica, sans-serif" fill="#fff" font-weight="bold">Zalo</text>
      </svg>
    </span>
  </a>
  {% endif %}
  <!-- Chat Button -->
  {% if chat_config.is_enabled %}
  <button id="open-chat-btn" class="floating-btn position-relative" type="button" title="Chat với hỗ trợ" data-chat-enabled="true">
    <i class="bi bi-chat-dots fs-4"></i>
    <span id="customer-chat-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size:0.8em;z-index:1;display:none;transform:translate(-50%,-50%);">0</span>
  </button>
  <audio id="customer-chat-audio" src="{% static 'audio/notification.mp3' %}" preload="auto"></audio>
  {% endif %}
  <!-- Site Map Button -->
  <a href="#" id="openSiteMap" class="floating-btn" title="Site Map">
    <i class="bi bi-diagram-3"></i>
  </a>
</div>

<!-- Site Map Modal -->
<div class="modal fade" id="siteMapModal" tabindex="-1" aria-labelledby="siteMapModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="siteMapModalLabel"><i class="bi bi-diagram-3 me-2"></i>Site Map - Sơ đồ website</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4" id="siteMapModalBody">
        <div class="text-center text-muted">Đang tải sơ đồ website...</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script>
// Đổi icon hamburger thành X khi mở menu
const toggler = document.querySelector('.navbar-toggler');
const togglerIcon = document.getElementById('navbarTogglerIcon');
const mainNavbar = document.getElementById('mainNavbar');
if (toggler && togglerIcon && mainNavbar) {
  toggler.addEventListener('click', function() {
    setTimeout(function() {
      if (mainNavbar.classList.contains('show')) {
        togglerIcon.classList.remove('bi-list');
        togglerIcon.classList.add('bi-x');
      } else {
        togglerIcon.classList.remove('bi-x');
        togglerIcon.classList.add('bi-list');
      }
    }, 100);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const backToTop = document.getElementById('backToTop');
  window.addEventListener('scroll', function() {
    if (window.scrollY > 200) {
      backToTop.style.display = 'flex';
    } else {
      backToTop.style.display = 'none';
    }
  });
  backToTop.addEventListener('click', function(e) {
    e.preventDefault();
    window.scrollTo({top: 0, behavior: 'smooth'});
  });
  // Ẩn mặc định
  backToTop.style.display = 'none';
});

document.addEventListener('DOMContentLoaded', function() {
  function renderCartDropdown(data, contentId, badgeId) {
    let html = `<div class="cart-dropdown-header p-3 border-bottom d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">Giỏ hàng của bạn</h6>
                  <span class="badge bg-primary rounded-pill">${data.total_items} sản phẩm</span>
                </div>
                <div class="cart-dropdown-body p-3">`;
    if (data.items.length > 0) {
      html += '<div class="cart-items">';
      data.items.forEach(item => {
        html += `<div class="cart-item d-flex align-items-center gap-3 mb-3">
                  <div class="cart-item-image" style="width: 60px; height: 60px;">
                    <img src="${item.image || '/static/img/product_placeholder.png'}" alt="${item.name}" class="img-fluid rounded" style="width: 100%; height: 100%; object-fit: cover;">
                  </div>
                  <div class="cart-item-details flex-grow-1">
                    <h6 class="mb-1">${item.name}</h6>
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="text-muted small">${item.quantity} x ${item.price.toLocaleString()} đ</div>
                      <div class="fw-bold">${item.total.toLocaleString()} đ</div>
                    </div>
                  </div>
                </div>`;
      });
      html += `</div>
        <div class="cart-dropdown-footer border-top pt-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Tổng cộng:</span>
            <span class="fw-bold text-primary">${data.total.toLocaleString()} đ</span>
          </div>
          <div class="d-grid gap-2">
            <a href="/cart/" class="btn btn-primary"><i class="fas fa-shopping-cart me-2"></i>Xem giỏ hàng</a>
            <a href="/orders/checkout/" class="btn btn-success"><i class="fas fa-credit-card me-2"></i>Thanh toán</a>
          </div>
        </div>`;
    } else {
      html += `<div class="text-center py-4">
                <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                <p class="text-muted mb-0">Giỏ hàng của bạn đang trống</p>
              </div>`;
    }
    html += '</div>';
    document.getElementById(contentId).innerHTML = html;
    // Badge update
    const badge = document.getElementById(badgeId);
    if (badge) {
      if (data.total_items > 0) {
        badge.textContent = data.total_items;
        badge.style.display = '';
      } else {
        badge.style.display = 'none';
      }
    }
  }

  function fetchAndRenderCartDropdown(contentId, badgeId) {
    fetch('/cart/api/')
      .then(res => res.json())
      .then(data => renderCartDropdown(data, contentId, badgeId));
  }

  // Mobile
  const cartDropdownMobile = document.getElementById('cartDropdownMobile');
  if (cartDropdownMobile) {
    cartDropdownMobile.addEventListener('show.bs.dropdown', function () {
      fetchAndRenderCartDropdown('cartDropdownContentMobile', 'cartDropdownBadgeMobile');
    });
    // Badge update on load
    fetchAndRenderCartDropdown('cartDropdownContentMobile', 'cartDropdownBadgeMobile');
  }

  // Desktop
  const cartDropdownDesktop = document.getElementById('cartDropdownDesktop');
  if (cartDropdownDesktop) {
    cartDropdownDesktop.addEventListener('show.bs.dropdown', function () {
      fetchAndRenderCartDropdown('cartDropdownContentDesktop', 'cartDropdownBadgeDesktop');
    });
    // Badge update on load
    fetchAndRenderCartDropdown('cartDropdownContentDesktop', 'cartDropdownBadgeDesktop');
  }
});

document.addEventListener('DOMContentLoaded', function() {
  var toggleBtn = document.getElementById('toggleProductCategories');
  var list = document.getElementById('productCategoriesList');
  var chevron = document.getElementById('chevronProductCategories');
  if (toggleBtn && list && chevron) {
    toggleBtn.addEventListener('click', function(e) {
      e.preventDefault();
      list.classList.toggle('d-none');
      chevron.classList.toggle('bi-chevron-down');
      chevron.classList.toggle('bi-chevron-up');
    });
  }
});

document.addEventListener('DOMContentLoaded', function() {
  // Site Map Modal
  const openBtn = document.getElementById('openSiteMap');
  const siteMapModal = new bootstrap.Modal(document.getElementById('siteMapModal'));
  openBtn.addEventListener('click', function(e) {
    e.preventDefault();
    // Tải nội dung site map qua AJAX
    fetch('/sitemap-modal/')
      .then(res => res.text())
      .then(html => {
        document.getElementById('siteMapModalBody').innerHTML = html;
        siteMapModal.show();
      });
  });
});

// --- ADMIN CHAT BELL DROPDOWN & POPUP (reused from admin_chat_bell.html) ---
  let lastUnreadCount = 0;
  let unreadConversations = [];
  function checkAdminUnread() {
    fetch('/chat/api/admin-unread-list/')
      .then(res => res.json())
      .then(data => {
        const badge = document.getElementById('admin-chat-badge');
        unreadConversations = data.unread_list || [];
        if (unreadConversations.length > 0) {
          badge.textContent = unreadConversations.length;
          badge.style.display = '';
          if (unreadConversations.length > lastUnreadCount) {
          document.getElementById('admin-chat-audio').play();
          }
        } else {
          badge.style.display = 'none';
        }
        lastUnreadCount = unreadConversations.length;
        renderUnreadDropdown();
      });
  }
  setInterval(checkAdminUnread, 5000);
  checkAdminUnread();

  function renderUnreadDropdown() {
  const list = document.getElementById('admin-chat-unread-list');
  if (!list) return;
    list.innerHTML = '';
    if (unreadConversations.length === 0) {
      list.innerHTML = '<li class="list-group-item text-center text-muted">Không có tin nhắn mới</li>';
      return;
    }
    unreadConversations.forEach(conv => {
      const li = document.createElement('li');
      li.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
      li.style.cursor = 'pointer';
      li.onclick = function() {
        openAdminChatPopup(conv.conversation_id);
      document.getElementById('admin-chat-dropdown').style.display = 'none';
        setTimeout(checkAdminUnread, 500);
      };
      li.innerHTML = `<span><i class='bi bi-person-circle me-1'></i>${conv.customer_name || 'Khách #'+conv.conversation_id}</span><span class='badge bg-danger'>${conv.unread_count}</span>`;
      list.appendChild(li);
    });
  }

const adminChatBell = document.getElementById('admin-chat-bell');
if (adminChatBell) {
  adminChatBell.onclick = function(e) {
    e.stopPropagation();
    const dropdown = document.getElementById('admin-chat-dropdown');
    if (dropdown) {
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
  };
}
  document.addEventListener('click', function() {
    const dropdown = document.getElementById('admin-chat-dropdown');
    if (dropdown) dropdown.style.display = 'none';
  });

const adminConsultBell = document.getElementById('admin-consult-bell');
if (adminConsultBell) {
  adminConsultBell.onclick = function(e) {
    e.preventDefault();
    window.location.href = '/consultations/admin/';
  };
}

  function openAdminChatPopup(conversationId) {
    if (document.getElementById('admin-chat-popup-' + conversationId)) {
      document.getElementById('admin-chat-popup-' + conversationId).style.display = 'block';
      return;
    }
    const offset = 32 + document.querySelectorAll("[id^='admin-chat-popup-']").length * 370;
    const popup = document.createElement('div');
    popup.id = 'admin-chat-popup-' + conversationId;
    popup.className = 'card shadow';
    popup.style = 'min-width:320px;max-width:350px;position:fixed;top:80px;right:' + offset + 'px;z-index:10000;';
    popup.innerHTML = `
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-chat-dots me-2"></i>Chat với khách #${conversationId}</span>
        <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('admin-chat-popup-${conversationId}').remove()"></button>
      </div>
      <div class="card-body" style="height:320px;overflow-y:auto;" id="admin-chat-messages-${conversationId}"></div>
      <div class="card-footer">
        <form onsubmit="return sendAdminChatMessage(${conversationId})" class="d-flex gap-2">
          <input type="text" id="admin-chat-input-${conversationId}" class="form-control" placeholder="Nhập tin nhắn..." autocomplete="off">
          <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
        </form>
      </div>
    `;
  document.getElementById('admin-chat-popups').appendChild(popup);
    loadAdminMessages(conversationId);
    popup._interval = setInterval(function() {
      if (document.getElementById('admin-chat-popup-' + conversationId)) {
        loadAdminMessages(conversationId);
      } else {
        clearInterval(popup._interval);
      }
    }, 3000);
  }

  function loadAdminMessages(conversationId) {
    fetch(`/chat/api/messages/${conversationId}/`)
      .then(res => res.json())
      .then(data => {
        const messages = document.getElementById('admin-chat-messages-' + conversationId);
        if (!messages) return;
        messages.innerHTML = '';
        data.messages.forEach(msg => {
          messages.innerHTML += `<div class='mb-2 ${msg.is_admin ? "text-end" : ""}'>
            <span class='badge bg-${msg.is_admin ? "primary" : "secondary"}'>${msg.sender}</span>
            <span class='ms-2'>${msg.content}</span>
            <span class='text-muted small ms-2'>${msg.timestamp}</span>
          </div>`;
        });
        messages.scrollTop = messages.scrollHeight;
      });
  }

function sendAdminChatMessage(conversationId) {
    const input = document.getElementById('admin-chat-input-' + conversationId);
    if (input.value.trim()) {
      const formData = new FormData();
      formData.append('conversation_id', conversationId);
      formData.append('content', input.value);
      fetch('/chat/api/send/', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
      })
      .then(res => res.json())
      .then(data => {
        input.value = '';
        loadAdminMessages(conversationId);
      });
    }
    return false;
}
</script>
{% block extra_js %}{% endblock %}
</body>
</html> 